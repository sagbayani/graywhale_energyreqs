---
title: "Total Gross Energy Requirements for calves from birth to weaning"
author: "Selina Agbayani"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  github_document:
  html_document:
    
editor_options:
  chunk_output_type: console
classoption: landscape
---



```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)

## Setup

# Initialize all libraries, set paths for output figures, then import the gw_observations.csv
# install.packages("tidyr")
# install.packages("readr")
# install.packages("tidyverse")
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("knitr")
# install.packages("nls2")
# install.packages("nlstools")
# install.packages("nlme")
# install.packages("minpack.lm")
# install.packages("scales")
# install.packages("ggpmisc")
# install.packages("extrafont")
# install.packages("gtable")
# install.packages("ggpubr")

library(tidyverse)
library(tidyr)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(nls2)
library(nlstools)
library(nlme)
library(minpack.lm)
library(scales)
library(ggpmisc)
library(reshape2)
library(extrafont)
library(gtable)
library(ggpubr)

#quiet col types messages
options(readr.show_col_types = FALSE)

 
```



```{r functions, include=FALSE}

#Call R script with custom functions
source(paste0(getwd(),"/functions.R"), local = knitr::knit_global())
```   


```{r setpaths}       
# Set path for output figures: 
Figurespath <- paste0(getwd(), "/gross_energetic_reqs/figures", collapse = NULL)
Figurespath

# Set path for input & output data  
datapath <- paste0(getwd(), "/data", collapse = NULL) 
datapath

```

```{r read in data}

#read in GER phase 1 table to calculate total GER from birth to weaning 
predict_GER_table_phase1_permth<- read_csv("data/predict_GER_table_sensAnalysis_phase1_permth_source_bpm.csv")
predict_GER_table_phase1_permth <-  predict_GER_table_phase1_permth %>% filter(age_mth <= 10 & MC_variable == "all" & sex == "N/A") %>% 
   select(phase, age_yrs,age_mth, sex, mean_GER, GER_sd, Ts)



```


#### Calculating total GER from birth to 6mths, and from 7mth-9.6mth, and also from birth to 9.6 mth

```{r GER_birth_to_weaning}

#Calculate total GER from birth to end of fasting (at 6 mths)  
predict_GER_0to6mth <-  predict_GER_table_phase1_permth %>% filter(age_mth <= 6)

predict_GER_0to6mth$GER_mth <- predict_GER_0to6mth$mean_GER * predict_GER_0to6mth$Ts

predict_GER_0to6mth$GER_sd_sqrd <- predict_GER_0to6mth$GER_sd ^2
kable(predict_GER_0to6mth)

TotalGER_0to6mth_tibble <- predict_GER_0to6mth %>%
  select(age_yrs, sex, mean_GER, GER_mth, GER_sd, GER_sd_sqrd) %>%
  group_by(sex) %>%
  summarize(Total_GER = sum(GER_mth), Total_GER_sd = sqrt(sum(GER_sd_sqrd)))


TotalGER_0to6mth_tibble$age_range <- "0 to 6 mths"
TotalGER_0to6mth_tibble  <-  TotalGER_0to6mth_tibble %>% relocate(age_range)
TotalGER_0to6mth_tibble$details <- "birth to end of nursing mother fasting"

kable(TotalGER_0to6mth_tibble)

GERcalf6mths_tibble  <-  TotalGER_0to6mth_tibble %>% filter(sex == "N/A")
GERcalf_6mths <- GERcalf6mths_tibble$Total_GER
GERcalf_6mths_sd <- GERcalf6mths_tibble$Total_GER_sd


#Calculating GER till weaning at 9.6 months

#need to adjust October to 20 days worth of GER because weaning is at 9.6 mths.
mean_GER_10th <- predict_GER_table_phase1_permth %>% 
  filter(age_mth == 10) %>% 
  pull(mean_GER)

Ts_9.6 <- 20 #nursing for 20 days out of 31 days in Oct

mean_GER_9.6 <- mean_GER_10th * (20/31) 

sd_GER_9.6 <- predict_GER_table_phase1_permth %>%  
  filter(age_mth == 10) %>%  
  pull(GER_sd)*(20/31)

sd_GER_9.6_sqrd <-sd_GER_9.6^2

Oct_row <- tibble(phase = "1",
              age_yrs = (9.6/12),
              age_mth = 9 + (20/31),
              sex = "N/A",
              mean_GER = mean_GER_9.6,
              GER_sd = sd_GER_9.6,
              Ts = Ts_9.6,
              GER_mth = mean_GER_9.6*Ts_9.6,
              GER_sd_sqrd = sd_GER_9.6_sqrd
)


#Total GER for calf from start of Mother foraging while lactating (7 mths) to weaning (9.6 mths) 
predict_GER_7to9mth <-  predict_GER_table_phase1_permth %>% 
  filter(age_mth >= 7 & age_mth <=9) %>%
  select(phase, age_yrs, age_mth, sex, mean_GER, GER_sd, Ts)

predict_GER_7to9mth$GER_mth <- predict_GER_7to9mth$mean_GER * predict_GER_7to9mth$Ts

predict_GER_7to9mth$GER_sd_sqrd <- predict_GER_7to9mth$GER_sd ^2
kable(predict_GER_7to9mth)

predict_GER_7to9.6mth <- rbind(predict_GER_7to9mth, Oct_row)

TotalGER_7to9.6mth_tibble <- predict_GER_7to9.6mth %>%
  select(age_yrs, sex, mean_GER, GER_mth, GER_sd, GER_sd_sqrd) %>%
  group_by(sex) %>%
  summarize(Total_GER = sum(GER_mth), Total_GER_sd = sqrt(sum(GER_sd_sqrd)))

TotalGER_7to9.6mth_tibble$age_range <- "7 to 9.6 mths"
TotalGER_7to9.6mth_tibble  <-  TotalGER_7to9.6mth_tibble %>% relocate(age_range)
TotalGER_7to9.6mth_tibble$details <- "start of nursing mother foraging to weaning"

kable(TotalGER_7to9.6mth_tibble)

TotalGER_for0to6_7to9.6_tibble <- rbind(TotalGER_0to6mth_tibble,TotalGER_7to9.6mth_tibble)

kable(TotalGER_for0to6_7to9.6_tibble)


#Total GER for calf from birth to weaning (9.6 mths) 
predict_GER_0to9mth <-  predict_GER_table_phase1_permth %>% 
  filter(age_mth >= 0 & age_mth <=9) %>%
  select(phase, age_yrs, age_mth, sex, mean_GER, GER_sd, Ts)

predict_GER_0to9mth$GER_mth <- predict_GER_0to9mth$mean_GER * predict_GER_0to9mth$Ts

predict_GER_0to9mth$GER_sd_sqrd <- predict_GER_0to9mth$GER_sd ^2
kable(predict_GER_0to9mth)

predict_GER_0to9.6mth <- rbind(predict_GER_0to9mth, Oct_row)

TotalGER_0to9.6mth_tibble <- predict_GER_0to9.6mth %>%
  select(age_yrs, sex, mean_GER, GER_mth, GER_sd, GER_sd_sqrd) %>%
  group_by(sex) %>%
  summarize(Total_GER = sum(GER_mth), Total_GER_sd = sqrt(sum(GER_sd_sqrd)))

TotalGER_0to9.6mth_tibble$age_range <- "0 to 9.6 mths"
TotalGER_0to9.6mth_tibble  <-  TotalGER_0to9.6mth_tibble %>% relocate(age_range)
TotalGER_0to9.6mth_tibble$details <- "birth to weaning"

kable(TotalGER_0to9.6mth_tibble)

TotalGER_birth_to_weaning_tibble <- rbind(TotalGER_0to6mth_tibble,
                                          TotalGER_7to9.6mth_tibble,
                                          TotalGER_0to9.6mth_tibble )

kable(TotalGER_birth_to_weaning_tibble)


TotalGER_birth_to_weaning_tibble %>% write_csv("data/TotalGER_birth_to_weaning_tibble.csv", na = "", append = FALSE)

```


**Total GER from birth to weaning, taking into account foraging time for nursing mother.**

```{r plot, echo=FALSE}

TotalGER_birth_to_weaning_tibble <-  read_csv("data/TotalGER_birth_to_weaning_tibble.csv")
TotalGER_birth_to_weaning_plot <- TotalGER_birth_to_weaning_tibble %>% 
  ggplot()+
  geom_errorbar(aes(x = age_range, 
                    ymin = Total_GER - Total_GER_sd, 
                    ymax = Total_GER + Total_GER_sd), 
                width=0, linetype = 1,color="black") + 
  # geom_point(aes(x = age_range, y= Total_GER),
  #            shape = 21, size = 5) +
    geom_bar(aes(x = age_range, y= Total_GER),
             stat = "identity", fill = "gray80") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 8),
                     labels = comma)+
  xlab("Age range (months)") +
  ylab(bquote('Total GER (MJ)')) +
  theme_bw() 
  #theme(panel.grid = element_blank())
  

TotalGER_birth_to_weaning_plot


```



