---
title: "ENERGY REQUIREMENTS OF GREY WHALES"
author: "Selina Agbayani"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  github_document:
  html_document:
 
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(warning = FALSE)

## Setup

# Initialize all libraries, set paths for output figures, then import the gw_observations.csv
# install.packages("tidyr")
# install.packages("tidyverse")
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("knitr")
# install.packages("scales")
# install.packages("ggpmisc")
# install.packages("extrafont")
#install.packages("truncnorm")



library(tidyverse)
# library(tidyr)
# library(dplyr)
# library(ggplot2)
library(knitr)
library(scales)
library(ggpmisc)
library(reshape2)
library(extrafont)
library(truncnorm)
library(gtable)
library(ggpubr)




#quiet col types messages
options(readr.show_col_types = FALSE)

```


```{r functions, include=FALSE}
#Call R script with custom functions
source("../functions.R", local = knitr::knit_global())

```   



```{r setpaths, include = FALSE}
# Set path for output figures: 
Figurespath <- paste0(getwd(), "/results_for_paper/figures", collapse = NULL)
Figurespath
# Set path for input & output data  
datapath <- paste0(getwd(), "/data", collapse = NULL) 
datapath

```


## RESULTS

### Production cost (P)


```{r P_cost_phase1, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

#### Gray whale calves
P_cost_table  <-  read_csv("data/P_cost_table_phase1.csv")

plot_P_cost_mass_perday <- P_cost_table %>%
  dplyr::filter(sex == "N/A") %>%
  ggplot() +
  # geom_errorbar(aes(x = age_mth-0.5, 
  #                   ymin = (mass - mass_sd) /50, 
  #                 ymax = (mass + mass_sd) /50), 
  #               width=0, size=1, linetype = 2, color="gray40") +
  geom_ribbon(aes(x = age_mth, 
                  ymin = (mass - mass_sd) /12, 
                  ymax = (mass + mass_sd) /12), 
              fill = "gray", alpha = 0.8)+
  geom_line(aes(x = age_mth, y = mass/12), 
             linetype = 2, size = 0.5, colour = "black")+
  geom_errorbar(aes(x = age_mth-0.5, 
                    ymin = mean_P_perday - sd_P_perday, 
                    ymax = mean_P_perday + sd_P_perday), 
                width=0, size=0.5, linetype = 1, color="gray40") +
  geom_point(aes(x = age_mth-0.5, y= mean_P_perday), size = 2)+
  labs(tag = "A")+
  theme(plot.tag = element_text(size = rel(6), colour = "black"))+
  xlab("Age (months)") +
  ylab(bquote('Production cost (MJ day'^'-1'*')'))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10),
                     limits = c(0, 12)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 8),
                     limits = c(0, 550),
                     labels = scales::comma,
                     sec.axis=sec_axis(~.*12, name = "Mass (kg)",
                                       labels = scales::comma,
                                       breaks = scales::pretty_breaks(n = 10))
                     
                     )+
                     #breaks = scales::pretty_breaks(n = 8))+
                       #limits = c(0, 50)) +
  theme_bw() + 
  theme(panel.grid = element_blank())+
  theme(legend.position = "none")+
    theme(legend.background = element_rect(fill = "white"))+
    theme(legend.text = element_text(colour = "black", size = rel(1)))+
    theme(legend.key = element_rect(fill = "transparent"))+ #colour = "transparent"))+
    ggtitle(element_blank()) +
    theme(plot.background = element_rect(fill = "white"))+
    theme(panel.background = element_rect(fill = "white"))+
    theme(panel.border = element_blank())+
    theme(axis.line = element_line(colour = "black"))+
    theme(axis.text = element_text(colour = "black", size = rel(1)))+
    theme(axis.title.y = element_text(colour = "black", 
                                      size = rel(1), 
                                      angle = 90, 
                                      margin = margin(t = 0, r = 10, b = 0, l = 0)))+
    theme(axis.title.x = element_text(colour = "black", size = rel(1)))+
    theme(axis.ticks = element_line(colour="black"))+
    theme(axis.title.y.right  = element_text(colour = "black", 
                                      size = rel(1), 
                                      angle = 270, 
                                      margin = margin(t = 0, r = 0, b = 0, l = 10)))+
    annotate("text", x= 12, y = 25,
             label = "P cost", 
             hjust = 1,
             size = rel(4),
             color = "black") +
    annotate("text", x= 12, y = 550,
             label = "Mass", 
             hjust = 1,
             size = rel(4),
             color = "black")
  


#plot_P_cost_mass_perday
```


```{r P_cost_peryear, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}
#### Juveniles and Adults

P_cost_table_peryear  <- read_csv("data/P_cost_table_peryear.csv")

plot_P_cost_mass_peryear <- P_cost_table_peryear %>% filter(sex == "N/A" & age_yrs >=1 & age_yrs<=30) %>%  
  ggplot() +
  geom_ribbon(aes(x = age_yrs, 
                  ymin = (mean_mass - sd_mass) /100, 
                  ymax = (mean_mass + sd_mass) /100), 
              fill = "gray", alpha = 0.8)+
  geom_line(aes(x = age_yrs, y = mean_mass/100), 
             linetype = 2, size = 0.5, colour = "black")+
  geom_ribbon(aes(x = age_yrs, 
                  ymin = (mean_P_perday - sd_P_perday),
                  ymax = (mean_P_perday + sd_P_perday)), 
                  #width = 0, linetype = 3, size = 1, colour= "white")+
              fill = "gray", alpha = 0.8)+
  geom_line(aes(x = age_yrs, y= mean_P_perday), 
              size = 0.5, linetype = 3, colour = "black")+
  labs(tag = "B")+
  theme(plot.tag = element_text(size = rel(6), colour = "black"))+
  xlab("Age (years)") +
  ylab(bquote('Production cost (MJ day'^'-1'*')'))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 9))+
                     #limits = c(0, 50)) +  
  scale_y_continuous(labels= scales::comma,
                     sec.axis=sec_axis(~.*100, name = "Mass (kg)",
                                       labels = scales::comma), 
                     breaks = scales::pretty_breaks(n = 8) 
                     )+
                       #limits = c(0, 50)) +
          
  theme_bw() + 
  theme(panel.grid = element_blank())+
  theme(legend.position = "none")+
    theme(legend.background = element_rect(fill = "white"))+
    theme(legend.text = element_text(colour = "black", size = rel(1)))+
    theme(legend.key = element_rect(fill = "transparent"))+ #colour = "transparent"))+
    ggtitle(element_blank()) +
    theme(plot.background = element_rect(fill = "white"))+
    theme(panel.background = element_rect(fill = "white"))+
    theme(panel.border = element_blank())+
    theme(axis.line = element_line(colour = "black"))+
    theme(axis.text = element_text(colour = "black", size = rel(1)))+
    theme(axis.title.y = element_text(colour = "black", 
                                      size = rel(1), 
                                      angle = 90, 
                                      margin = margin(t = 0, r = 10, b = 0, l = 0)))+
    theme(axis.title.x = element_text(colour = "black", size = rel(1)))+
    theme(axis.ticks = element_line(colour="black"))+
  theme(axis.title.y.right  = element_text(colour = "black", 
                                      size = rel(1), 
                                      angle = 270, 
                                      margin = margin(t = 0, r = 0, b = 0, l = 10)))+
    annotate("text", x= 30, y = 25,
             label = "Production cost", 
             hjust = 1,
             size = rel(4),
             color = "black") +
    annotate("text", x= 30, y = 220,
             label = "Mass", 
             hjust = 1,
             size = rel(4),
             color = "black") 

  
  
  


#plot_P_cost_mass_peryear


multiplot(plot_P_cost_mass_perday,plot_P_cost_mass_peryear,
          cols=1)


jpeg(filename = paste0(Figurespath,"/Pcost_multiplot.jpg"), 
     width = 1800,
     height = 2000,
     pointsize = 35, 
     quality = 100, 
     bg = "white", 
     res = 300, 
     restoreConsole = TRUE)


p <- multiplot(plot_P_cost_mass_perday,plot_P_cost_mass_peryear,
          cols=1)


dev.off()


```

Figure 2. Production cost for calves (panel A) and juveniles and adults (panel B).


### Total Energetic Expenditure (*E~s~*)


```{r Es_table_phase1_permth, echo= FALSE, results = "hide", message = FALSE, warning=FALSE }
#### Grey whale calves
Es_table_phase1_permth  <-  read_csv("data/Es_sensAnalysis_phase1_permth_source_bpm.csv")

# apply factors to enable facet wrap 
Es_table_phase1_permth$Lifestage = factor(Es_table_phase1_permth$Lifestage,                                                          levels=c('Calf'))


plot_Es_table_phase1_mthly_perday <- Es_table_phase1_permth %>% 
  #dplyr::filter(age_yrs == i) %>% 
  ggplot(aes(x = age_mth-0.5, y =Es_perday)) +
  facet_grid(. ~Lifestage)+
  geom_errorbar(aes(ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                linewidth = 0.5, linetype = 1, colour = 'gray40', width = 0) +
  geom_point(aes(x = age_mth-0.5, y =Es_perday), size = 0.8) +
  xlab("Age (months)") +
  ylab(bquote('Es (MJ day'^'-1'*')')) +
  #ylab(bquote('GER (MJ day '^'-1'*')'))
  
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))+ 
  #limits = c(0, 30)) +  # max x-axis 30 yrs. 
  scale_y_continuous(label = comma, 
                     breaks = scales::pretty_breaks(n = 10),
                     limits = c(0,550))+
  theme_bw()+
    labs(tag = "A")+
  theme(plot.tag = element_text(size = rel(1.5), 
                                colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(axis.title.x = element_text(size = rel(1),
                                    colour = "black"))+
  theme(axis.title.y = element_text(size = rel(1.1),
                                    colour = "black"))+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))+
  theme(strip.background =element_rect(fill="transparent", 
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1)))
#ggtitle("Es table Phase 1 - per mth")

#plot_Es_table_phase1_mthly_perday

```


```{r Es_table_alladults_preg_lact_peryear, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}
#### Grey whale juveniles and adults, including pregnant and lactating females
Es_table_alladults_preg_lact_peryear  <- 
  read_csv("data/Es_sensAnalysis_alladults_preg_lact_peryear_source_bpm.csv")

# apply factors to enable facet wrap 
Es_table_alladults_preg_lact_peryear$Lifestage_f = factor(Es_table_alladults_preg_lact_peryear$Lifestage,
                                                          levels=c('Juvenile/Adult','Pregnant','Lactating'))


# plots  

plot_Es_table_alladults_preg_lact_yearly_perday <- 
  Es_table_alladults_preg_lact_peryear %>% 
  ggplot(aes(x = age_yrs, y =Es_perday)) + #shape = Lifestage
  facet_grid(. ~Lifestage_f)+
  geom_errorbar(aes(x = age_yrs, 
                    ymin = Es_perday - Es_sd_perday, 
                    ymax = Es_perday + Es_sd_perday),
                linewidth = 0.5, colour = 'gray40', width = 0, linetype = 1) +
  # geom_ribbon(aes(x = age_yrs, ymin = Es - Es_sd, ymax = Es + Es_sd),
  #                 fill = 'gray40', alpha = 0.3) +
  geom_point(size =0.8)+
  #geom_line()   +
  xlab("Age (years)") +
  ylab(bquote('Energetic expenditure (MJ day'^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), 
                     limits = c(0, 32)) +  # max x-axis 30 yrs. 
  scale_y_continuous(label = comma, 
                     breaks = scales::pretty_breaks(n = 8),
                     limits = c(0,max(Es_table_alladults_preg_lact_peryear$Es_perday +
                                        Es_table_alladults_preg_lact_peryear$Es_sd_perday)))+
  # scale_y_continuous(label = function(x){(x/1000)}, breaks = scales::pretty_breaks(n = 8),
  #                    limits = c(0, 1000000))+
  
  theme_bw()+
    labs(tag = "B")+
  theme(plot.tag = element_text(size = rel(1.5), 
                                colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(1)),
        axis.title.y = element_text(size = rel(0.5), colour = "white"))+
  theme(strip.background =element_rect(fill="transparent", 
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1)))
#theme(legend.position = "none")

#plot_Es_table_alladults_preg_lact_yearly_perday

```




```{r Es all ages multipanel, echo=FALSE}

ES_multipanel <- ggarrange(plot_Es_table_phase1_mthly_perday, 
            plot_Es_table_alladults_preg_lact_yearly_perday, 
            widths = c(2, 5)) 

ES_multipanel

ggsave(paste0(Figurespath,"/Es_sensanalysis_allstages_multiplot.jpg"),
       ES_multipanel,
       width = 8,
       height = 3, dpi = 300
     )


#dev.off()
```

Figure 3. Estimates  of average daily energetic expenditure (Es)  from activity (MJ day-1) for each month in the first year (Phase 1). calves per month (Phase 1), and for juveniles and single adults (Phase 2), pregnant, and lactating females per year. Values are plotted at the midpoint of each month. Error bars show the standard deviation around the mean of 10,000 Monte Carlo simulations. Note: Energetic expenditure Es values for the 6th and 10th months represent energetic expenditures across two activity stages. 


### Gross Energy Requirements

#### Grey whale calves

```{r predict_GER_table_phase1_permth, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

predict_GER_table_phase1_permth <- read_csv("data/predict_GER_table_sensAnalysis_phase1_permth_source_bpm.csv")


plot_predict_GER_phase1_permth <- predict_GER_table_phase1_permth %>%
  filter(sex == "N/A") %>% 
  ggplot(aes(x = age_mth, y = mean_GER)) +
  geom_errorbar(aes(x = age_mth-0.5, 
                    ymin = mean_GER-GER_sd, 
                    ymax = mean_GER+GER_sd), 
                width=0, size = 0.5,
                linetype = 1,
                color="gray80") + 
  geom_point(aes(x = age_mth-0.5, y= mean_GER), 
             shape = 21, fill = "black")+
  xlab("Age (months)") +
  ylab(bquote('Gross Energy Reqs (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 12)) + 
  #limits = c(0, 30)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 7),
                     limits = c(0,1100)) + 
  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1.2),
                                 colour = "black")) +
  theme(axis.title.x = element_text(size = rel(1.5),
                                    colour = "black")) +
  theme(axis.title.y = element_text(size = rel(1.4),
                                    colour = "black"))



plot_predict_GER_phase1_permth


```

Figure 6. Daily Gross Energy Requirements (GER) for calves in the first year in MJ day^-1^. Error bars represent SD.

#### Grey whale juveniles / adults

```{r predict_GER_table_phase2, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

predict_GER_table_phase2 <- 
  read_csv("data/predict_GER_table_sensAnalysis_phase2.csv")

predict_GER_table_phase2 %>% 
  filter(sex=="N/A" & phase == "2" & age_yrs >= 1)%>% 
  head() %>% kable()
kable(head(predict_GER_table_phase2))

plot_predict_GER_all_yr_phase2 <- predict_GER_table_phase2 %>%
  filter(sex=="N/A" & phase == "2" & 
                  age_yrs > 1 & age_yrs <= 30) %>% 
  ggplot() +
  # geom_line(aes(x=age_yrs, y=mean_GER),
  #           color='black',
  #           size = 1.2,
  #           linetype = "longdash") +
  
  geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = mean_GER-GER_sd, 
                    ymax = mean_GER+GER_sd), 
                width=0, size=0.5, linetype = 1, color="gray80") + 
  geom_point(aes(x = age_yrs-0.5, y= mean_GER), shape = 21, fill = "black")+
  xlab("Age (years)") +
  ylab(bquote('Gross Energy Requirements (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10), 
                     limits = c(0, 30.5), expand = c(0,0)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10),
                     limits = c(-50, 4000), expand = c(0,0),
                     labels = comma)+
  
  theme_bw() +
  theme(panel.grid = element_blank()) +
  theme(axis.title = element_text(size = rel(1.4), colour = "black"))+
  theme(axis.text = element_text(size = rel(1.2), colour = "black"))+
  annotate("text", x = 28, y = 3500,
           label = paste0("Annual"),
           size = 6,
           hjust = 1) 

#plot_predict_GER_all_yr_phase2


plot_predict_GER_foraging_phase2 <- predict_GER_table_phase2 %>% 
  filter(sex=="N/A" & phase == "2" & 
                  age_yrs > 1 & age_yrs <= 30) %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = GER_foraging - GER_sd, 
                    ymax = GER_foraging + GER_sd), 
                width=0, size=0.5, linetype = 1, color="gray80") + 
  geom_point(aes(x = age_yrs-0.5, y= GER_foraging), 
             shape = 21, fill = "black")+
  xlab("Age (years)") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10), 
                     limits = c(0, 30.5), expand = c(0,0)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10),
                     limits = c(-50, 4000), expand = c(0,0))+
  
  theme_bw() +
  theme(panel.grid = element_blank()) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = rel(0.2), colour = NA))+
  theme(axis.title = element_text(size = rel(1.4), colour = "black"))+
  theme(axis.text = element_text(size = rel(1.2), colour = "black"))+
  annotate("text", x = 28, y = 3500,
           label = paste0("Foraging season"),
           size = 6,
           hjust = 1) 


#plot_predict_GER_foraging_phase2


plot_predict_GER_phase2_both_annual_foraging <- 
  ggarrange(plot_predict_GER_all_yr_phase2, 
            plot_predict_GER_foraging_phase2, 
            widths = c(2, 1.8)) 
plot_predict_GER_phase2_both_annual_foraging 

```

Figure 7. Daily gross energy requirements over the year compared to gross daily requirements when foraging is limited to the summer season.  Foraging season spans \~154 days for juveniles and adults. 



```{r predict_GER_table_preg_lact, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

predict_GER_table_3panel  <- read_csv("data/predict_GER_sensAnalysis_alladults_preg_lact.csv")

predict_GER_table_3panel <- within(predict_GER_table_3panel, Lifestage <- 
  factor(Lifestage, levels=c('Juvenile/Adult','Pregnant', 'Lactating')))



plot_GER_3panel <- predict_GER_table_3panel %>% 
  filter(age_yrs <=30) %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs-0.5, 
                  ymin = mean_GER-GER_sd,
                  ymax = mean_GER+GER_sd),
                size = 0.5, width=0, linetype = 1, color="gray80")+
  geom_point(aes(x = age_yrs-0.5, y= mean_GER),
              shape = 21, fill = "black") +
   geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = GER_foraging - sd_foraging,
                    ymax = GER_foraging + sd_foraging),
                size = 0.5, width=0, linetype = 1, color="gray80") +
  geom_point(aes(x = age_yrs-0.5, y= GER_foraging),
              shape = 21, fill = "white") +
  facet_grid(~Lifestage)+
  xlab("Age (years)") +
  ylab(bquote('Gross Energy Requirements (MJ day'^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 3),
                     limits = c(1,30)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10),
                     label = comma)+
  
  
  theme_bw() +
  theme(panel.grid = element_blank())+
  theme(axis.text =  element_text(size = rel(1.2), colour = "black"),
        axis.title = element_text(size = rel(1.2), colour = "black"),
        strip.background = element_rect(
          color="transparent", fill="transparent"),
        strip.text = element_text(size = rel(1.2), colour = "black"))
  # annotate("text", x = 20, y = 5200,
  #          label = paste0("Foraging season"),
  #          size = 6,
  #          hjust = 1) +
  # annotate("text", x = 20, y = 200,
  #          label = paste0("Annual"),
  #          size = 6,
  #          hjust = 1) 
  #   
ann_text_annual <- data.frame(age_yrs = 30, mean_GER = 900,
                              Lifestage = factor("Juvenile/Adult",
                                           levels = c("Juvenile/Adult",
                                                      "Pregnant",
                                                      "Lactating")))

ann_text_foraging <- data.frame(age_yrs = 30, mean_GER = 4200,
                                Lifestage = factor("Juvenile/Adult",
                                             levels = c("Juvenile/Adult",
                                                        "Pregnant",
                                                      "Lactating")))

plot_GER_3panel <- plot_GER_3panel +
  geom_text(data = ann_text_annual,
            aes(x=age_yrs, y=mean_GER),
            label = "Annual",
            size = 5,
            hjust = 1) +
  geom_text(data = ann_text_foraging,
            aes(x=age_yrs, y=mean_GER),
            label = "Foraging Season",
            size = 5,
            hjust = 1)

plot_GER_3panel


```

Figure 8. Estimates for gross energy requirements (GER) for pregnant, lactating females, and others (juvenile and other adult grey whales). Daily gross energy requirements for a full year (annual) are represented with black circles (365 for adults/juveniles, 396 for pregnant whales, and 293 days for lactating whales). White circles represent daily gross energy requirements for when feeding is limited during the foraging season. Foraging season is assumed to be ~154 days for single juveniles (1-7 y) and adults (> 8 y), \~153 days for pregnant females, and ~119 days for lactating females. GER for pregnant whales shown here assumes that the GER for first the 6 months of lactation while the mother is fasting need to be consumed the previous year, when foraging while pregnant. GER for lactating whales shown here is the GER for the remaining 3.6 months of lactation when the mother resumes foraging while lactating. Error bars represent SD.


### Milk / Food Requirements

#### Grey whale calves

```{r plot_milk_food_reqs_phase1,  echo= FALSE, results = "hide", message = FALSE, warning=FALSE}
predict_GER_table_phase1_permth <- read_csv("data/predict_GER_table_sensAnalysis_phase1_permth_source_bpm.csv")

plot_MilkReqs_phase1 <- predict_GER_table_phase1_permth %>% 
  dplyr::filter(sex == "N/A" & phase == "1") %>% 
  ggplot() +
  #geom_line(aes(x = age_yrs, y= FR_foraging))+
  geom_errorbar(aes(x = age_mth-0.5, ymin = FR_foraging - FR_sd_foraging, ymax = FR_foraging + FR_sd_foraging),
                size = 0.5, width=0, linetype = 1, color="gray80") + 
  geom_point(aes(x = age_mth-0.5, y= FR_foraging), shape = 21, fill = "black") +
  xlab("Age (months)") +
  ylab(bquote('Milk Requirements (L day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 9),
                     limits = c(0, 9.9), expand=c(0,0)) +  
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10),
                     limits = c(0, 45)) +
  theme_bw() + 
  theme(panel.grid = element_blank())+
  theme(axis.text =element_text(size = rel(1.4),
                                colour = "black"),
        axis.title.x = element_text(size = rel(1.6),
                                    colour = "black"),
        axis.title.y = element_text(size = rel(1.4),
                                    colour = "black")
  )


#plot_MilkReqs_phase1


plot_FoodReqs_phase1 <- predict_GER_table_phase1_permth %>% 
  filter(sex == "N/A" & phase == "1") %>% 
  ggplot() +
  #geom_line(aes(x = age_yrs, y= FR_foraging))+
  geom_errorbar(aes(x = age_mth-0.5, ymin = FR_foraging - FR_sd_foraging, ymax = FR_foraging + FR_sd_foraging),
                size = 0.5, width=0, linetype = 1, color="gray80") + 
  geom_point(aes(x = age_mth-0.5, y= FR_foraging), 
             shape = 21, fill = "black")+
  # geom_line(aes(x = age_yrs, y= quant025), linetype = "dashed", colour = "gray20")+
  # geom_line(aes(x = age_yrs, y= quant975), linetype = "dashed", colour = "gray20")+
  #facet_wrap(~sex)+
  #xlab("Age (months)") +
  ylab(bquote('Food Requirements (kg day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 2),
                     limits = c(9.9, 12), expand=c(0,0)
  ) +  # max x-axis 30 yrs.
  scale_y_continuous(position = "right",      label=comma,
                     breaks = scales::pretty_breaks(n = 10),
                     limits = c(0, 300)
  ) +
  theme_bw()+ 
  theme(panel.grid = element_blank(),
        axis.title.x = element_text(size = rel(1.6),
                                    colour = "white"))+
  theme(axis.text =element_text(size = rel(1.4),
                                colour = "black"),
        axis.title.y = element_text(size = rel(1.4),
                                    colour = "black")
  )

#theme(legend.position = 0)

#plot_FoodReqs_phase1



## plot milk and food requirments for phase 1 on same chart but different axes

#multiplot(plot_MilkReqs_phase1, plot_FoodReqs_phase1, cols = 2)

milkreqs_figure <- ggarrange(plot_MilkReqs_phase1, plot_FoodReqs_phase1, widths = c(2, 0.9))
milkreqs_figure


```

Figure 9. Daily milk requirements for calves. The left panel represents milk requirements (L day^-1^) for calves up to 9 months (left panel), and the right panel represents food requirements (kg of benthic invertebrate prey day^-1^) for weaned calves over 9 months.

#### Grey whale juveniles and adults, including pregnant and lactating

```{r plot_FoodReqs_3panel, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

predict_GER_table_3panel  <- read_csv("data/predict_GER_sensAnalysis_alladults_preg_lact.csv")

predict_GER_table_3panel <- within(predict_GER_table_3panel, Lifestage <- 
  factor(Lifestage, levels=c('Juvenile/Adult','Pregnant', 'Lactating')))


plot_FoodReqs_3panel <- predict_GER_table_3panel %>% 
  filter(age_yrs>1 & age_yrs<=30) %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs, 
                  ymin = FR_foraging-FR_sd_foraging,
                  ymax = FR_foraging+FR_sd_foraging),
                size = 0.5, width=0, linetype = 1, color="gray80")+
  geom_point(aes(x = age_yrs, 
                y= FR_foraging),  
            size = 1)+
  facet_wrap(~Lifestage)+
  xlab("Age (years)") +
  ylab(bquote('Food Requirements (kg day'^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 3),
                     limits = c(1,30)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))+
                     #limits = c(0, 20))+
  
  theme_bw() +
   theme(panel.spacing = unit(0.6, "lines"))+
  theme(panel.grid = element_blank())+
  theme(axis.text =  element_text(size = rel(1.2), colour = "black"),
        axis.title = element_text(size = rel(1.2), colour = "black"),
        strip.background = element_rect(
          color="transparent", fill="transparent"),
        strip.text = element_text(size = rel(1.2), colour = "black")
  )



plot_FoodReqs_3panel



```

Figure 10. Food requirements (kg day-1) of benthic invertebrate prey for pregnant females, lactating females, and others (juveniles and other adult grey whales) during foraging season. Foraging season is assumed to be ~154 days for single juveniles (1-7 y) and adults (> 8 y), ~153 days for pregnant females, and ~119 days for lactating females. Error bars represent SD.



```{r plot_pct_bodywt_consumed_3panel, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

pct_bodyweight_all <-  read_csv("data/predict_GER_sensAnalysis_alladults_preg_lact.csv")

pct_bodyweight_all <- within(pct_bodyweight_all, Lifestage <- 
  factor(Lifestage, levels=c('Juvenile/Adult','Pregnant', 'Lactating')))


plot_pct_bodyweight_all <- pct_bodyweight_all %>% 
  filter(age_yrs > 1 &age_yrs <=30) %>% 
  ggplot() +
   geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = pctbodywt - pctbodywt_sd, 
                    ymax = pctbodywt + pctbodywt_sd),
                width=0, size=0.5, linetype = 1, color="gray80")+
  geom_point(aes(x = age_yrs-0.5, y= pctbodywt), 
             shape = 21, fill = "black")+
  facet_wrap(~Lifestage)+
  xlab("Age (years)") +
  ylab(bquote('Consumption day'^'-1'*' (% body wt)')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 3),
                     limits = c(1,30)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 6)
                     #limits = c(3.5, 10)
                     )+
  
  theme_bw() +
  theme(panel.grid = element_blank())+
  theme(axis.text =  element_text(size = rel(1.2), colour = "black"),
        axis.title = element_text(size = rel(1.2), colour = "black"),
        strip.background = element_rect(
          color="transparent", fill="transparent"),
        strip.text = element_text(size = rel(1.2), colour = "black")
  )



plot_pct_bodyweight_all



```

Figure 11. Percentage of body weight consumed day-1 during the foraging season for juveniles and other adults, pregnant females, and lactating females. Foraging season is assumed to be ~154 days for single juveniles (1-7 y) and adults (> 8 y), ~153 days for pregnant females, and ~119 days for lactating females. Note that the y-axis does not start at 0. Error bars represent SD.





__Plotting Gross energetic requirements (multi-panel)__
```{r plots_GER_preg_lact_panel, echo =  FALSE}
predict_GER_table_alladults <- read_csv("data/predict_GER_sensAnalysis_alladults.csv")

predict_GER_table_panel <- within(predict_GER_table_alladults, Lifestage <- 
  factor(Lifestage, levels=c('Juvenile/Adult',
                             'Pregnant only', 
                             'Lactating (birth to 9.6 mths)',
                             'Pregnant (with first 6 mths lactation)',
                             'Lactating (last 3.6 mths)')
         )
  )



plot_GER_panel <- predict_GER_table_panel %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs-0.5, 
                  ymin = mean_GER-GER_sd,
                  ymax = mean_GER+GER_sd),
                width=0, linetype = 1, color="gray40")+
  geom_point(aes(x = age_yrs-0.5, y= mean_GER),
              shape = 21, fill = "black") +
   geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = GER_foraging - sd_foraging,
                    ymax = GER_foraging + sd_foraging),
                width=0, linetype = 1, color="gray40") +
  geom_point(aes(x = age_yrs-0.5, y= GER_foraging),
              shape = 21, fill = "white") +
  facet_grid(.~Lifestage, 
             labeller = label_wrap_gen(width = 17, 
               multi_line = TRUE))+
  xlab("Age (years)") +
  ylab(bquote('Gross Energetic Requirements (MJ day'^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 3),
                     limits = c(1,30)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 8),
                     label = comma)+
  theme_bw() +
  labs(tag = "A")+
  theme(plot.tag = element_text(size = rel(2), colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(axis.text =  element_text(size = rel(1.2), colour = "black"),
        axis.title = element_text(size = rel(1.2), colour = "black"),
        strip.background = element_rect(
          color="transparent", fill="transparent"),
        strip.text = element_text(size = rel(1), colour = "black"))
  # annotate("text", x = 20, y = 5200,
  #          label = paste0("Foraging season"),
  #          size = 6,
  #          hjust = 1) +
  # annotate("text", x = 20, y = 200,
  #          label = paste0("Annual"),
  #          size = 6,
  #          hjust = 1) +
  
#plot_GER_panel 

ann_text_annual <- data.frame(age_yrs = 30, mean_GER = 900,
                              Lifestage = factor("Juvenile/Adult",
                                levels = c('Juvenile/Adult','Pregnant only',
                                           'Lactating (birth to 9.6 mths)',
                                           'Pregnant (with first 6 mths lactation)',
                                           'Lactating (last 3.6 mths)')))

ann_text_foraging <- data.frame(age_yrs = 30, mean_GER = 3700,
                                Lifestage = factor("Juvenile/Adult",
                                  levels = c('Juvenile/Adult',
                                             'Pregnant only', 
                                             'Lactating (birth to 9.6 mths)',
                                             'Pregnant (with first 6 mths lactation)',
                                             'Lactating (last 3.6 mths)')))



plot_GER_panel <- plot_GER_panel + 
  geom_text(data = ann_text_annual, 
            aes(x=age_yrs, y=mean_GER),
            label = "Annual",
            size = 3.5,
            hjust = 1) +
  geom_text(data = ann_text_foraging, 
            aes(x=age_yrs, y=mean_GER),
            label = "Foraging Season",
            size = 3.5,
            hjust = 1)

#plot_GER_panel


```


```{r plot_FoodReqs_preg_lact_panel, echo = FALSE}

plot_FoodReqs_panel <- predict_GER_table_panel %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs, 
                  ymin = FR_foraging-FR_sd_foraging,
                  ymax = FR_foraging+FR_sd_foraging),
                width=0, linetype = 1, color="gray40")+
  geom_point(aes(x = age_yrs, 
                y= FR_foraging),  
            size = 1)+
  facet_grid(~Lifestage,
             labeller = label_wrap_gen(width = 17, 
             multi_line = TRUE))+
  xlab("Age (years)") +
  ylab(bquote('Food Requirements (kg day'^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 3),
                     limits = c(1,30)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))+
                     #limits = c(0, 20))+
  
  theme_bw() +
  labs(tag = "B")+
  theme(plot.tag = element_text(size = rel(2), colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(axis.text =  element_text(size = rel(1.2), colour = "black"),
        axis.title = element_text(size = rel(1.2), colour = "black"),
        strip.background = element_rect(
          color="transparent", fill="transparent"),
        strip.text = element_text(size = rel(1), colour = "black")
  )



#plot_FoodReqs_panel





```


```{r plot_pct_bodywt_consumed_panel, echo=FALSE}


plot_pct_bodyweight_all <- predict_GER_table_panel %>% 
  filter(age_yrs > 1) %>% 
  ggplot() +
   geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = pctbodywt - pctbodywt_sd, 
                    ymax = pctbodywt + pctbodywt_sd),
                width=0, size=0.5, linetype = 1, color="gray40")+
  geom_point(aes(x = age_yrs-0.5, y= pctbodywt), 
             shape = 21, fill = "black")+
  facet_grid(~Lifestage,
             labeller = label_wrap_gen(width = 17, 
             multi_line = TRUE))+
  xlab("Age (years)") +
  ylab(bquote('Consumption day'^'-1'*' (% body wt)')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 3),
                     limits = c(1,30)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 6)
                     #limits = c(3.5, 10)
                     )+
  
  theme_bw() +
  labs(tag = "C")+
  theme(plot.tag = element_text(size = rel(2), colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(axis.text =  element_text(size = rel(1.2), colour = "black"),
        axis.title = element_text(size = rel(1.2), colour = "black"),
        strip.background = element_rect(
          color="transparent", fill="transparent"),
        strip.text = element_text(size = rel(1), colour = "black")
  )



#plot_pct_bodyweight_all




```

```{r multiplot, echo=FALSE}


#save multi-panel plot as hi-res jpg
# multiplot(plot_GER_panel,plot_FoodReqs_panel, plot_pct_bodyweight_all, cols=1)


jpeg(filename = paste0(Figurespath,"/Figure6_multiplot.jpg"), 
     width = 2200,
     height = 3500,
     pointsize = 35, 
     quality = 100, 
     bg = "white", 
     res = 300, 
     restoreConsole = TRUE)


p <- multiplot(plot_GER_panel,plot_FoodReqs_panel, plot_pct_bodyweight_all, cols=1)


dev.off()


knitr::include_graphics(path = paste0(Figurespath,"/Figure6_multiplot.jpg"), rel_path = FALSE)


```



## Sensitivity Analyses

The sensitivity analyses show that the variable contributing the highest range of uncertainty (±SD) to the gross energy requirements is *E~s~* or total energetic expenditure (Figure 12), and that the variable contributing the highest range of uncertainty within the Es calculations is *%O~2~* or the percentage of oxygen absorbed (Figure 13). The pattern holds for Phase 2, pregnant, and lactating life stages, even when additional parameters are examined for the pregnant and lactating stages (see Appendix D). 

### Gross Energy Requirements (*GER*)


```{r predict_GER_table_sensAnalysis_phase1,  echo= FALSE, results = "hide", message = FALSE, warning=FALSE}
predict_GER_table_sensAnalysis_phase1_permth  <-  read_csv("data/predict_GER_table_sensAnalysis_phase1_permth_source_bpm.csv")


predict_GER_table_sensAnalysis_phase1_permth$MC_var_factor <- 
  factor(predict_GER_table_sensAnalysis_phase1_permth$MC_variable, 
         levels=c('all','P_cost','Es','E_FnU'))
levels(predict_GER_table_sensAnalysis_phase1_permth$MC_var_factor) <- 
   c("All variables", "P", "Es", "E F+U")

predict_GER_table_sensAnalysis_phase1_permth$Lifestage <-   factor(predict_GER_table_sensAnalysis_phase1_permth$phase, 
         levels=c('1'))

levels(predict_GER_table_sensAnalysis_phase1_permth$Lifestage) <- c('Calf')


plot_predict_GER_sensAnalysis_phase1_permth <- 
  predict_GER_table_sensAnalysis_phase1_permth %>%
  dplyr::filter(sex == "N/A") %>% 
  ggplot(aes(x = age_mth, y = mean_GER)) +
  geom_errorbar(aes(x = age_mth-0.5, 
                    ymin = mean_GER-GER_sd, 
                    ymax = mean_GER+GER_sd), 
                width=0, size = 0.5,
                linetype = 1,
                color="gray40") + 
  geom_point(aes(x = age_mth-0.5, y= mean_GER), 
             shape = 21, fill = "black")+
  facet_grid(Lifestage~MC_var_factor, 
             labeller = label_wrap_gen(width=25, multi_line = TRUE)) +
  xlab("Age (months)") +
  ylab(bquote('GER (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                     limits = c(0, 12.5)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 7),
                     limits = c(0,1100)) + 
  theme_bw()+
  labs(tag = "A")+
  theme(plot.tag = element_text(size = rel(3), 
                                colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(panel.spacing = unit(0.3, "lines"))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))+
    theme(strip.text = element_text(size = rel(2)))+
  theme(axis.text = element_text(size = rel(1.5),
                                 colour = "black")) +
  theme(axis.title.x = element_text(size = rel(2),
                                    colour = "black")) +
  theme(axis.title.y = element_text(size = rel(2),
                                    colour = "black"))


#plot_predict_GER_sensAnalysis_phase1_permth

```


```{r predict_GER_table_sensAnalysis_phase2,  echo= FALSE, results = "hide", message = FALSE, warning=FALSE}
predict_GER_table_sensAnalysis_phase2 <- read_csv("data/predict_GER_table_sensAnalysis_phase2.csv")

predict_GER_table_sensAnalysis_phase2 %>% 
  filter(sex=="N/A" & phase == "2" & age_yrs >= 1 )%>% 
  head() %>% kable()
kable(predict_GER_table_sensAnalysis_phase2)

predict_GER_table_sensAnalysis_phase2$MC_var_factor <- 
  factor(predict_GER_table_sensAnalysis_phase2$MC_variable, 
         levels=c('all','P_cost','Es','E_FnU'))

levels(predict_GER_table_sensAnalysis_phase2$MC_var_factor) <-  c("All variables", "P", "Es", "E F+U")

predict_GER_table_sensAnalysis_phase2$Lifestage <-   factor(predict_GER_table_sensAnalysis_phase2$phase, 
         levels=c('2'))

levels(predict_GER_table_sensAnalysis_phase2$Lifestage) <- c('Juvenile/Adult')


plot_predict_GER_table_sensAnalysis_phase2 <- predict_GER_table_sensAnalysis_phase2 %>%
  dplyr::filter(sex=="N/A" & phase == "2" & 
                  age_yrs > 1 & age_yrs <= 30) %>% 
  ggplot() +
  # geom_line(aes(x=age_yrs, y=mean_GER),
  #           color='black',
  #           size = 1.2,
  #           linetype = "longdash") +
  
  geom_errorbar(aes(x = age_yrs-0.5, 
                    ymin = mean_GER-GER_sd, 
                    ymax = mean_GER+GER_sd), 
                width=0, size = 0.5, linetype = 1, color="gray40") + 
  geom_point(aes(x = age_yrs-0.5, y= mean_GER), shape = 21, fill = "black")+
 facet_grid(Lifestage~MC_var_factor, 
             labeller = label_wrap_gen(width=25, multi_line = TRUE)) +
  xlab("Age (years)") +
  ylab(bquote('GER (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10), 
                     limits = c(0, 30.5), expand = c(0,0)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10),
                     #limits = c(-50, 4000), expand = c(0,0),
                     labels = comma)+
  #ggtitle("Juveniles / non-reproductive adults")+
  
  theme_bw() +
  labs(tag = "B")+
  theme(plot.tag = element_text(size = rel(3), 
                                colour = "black"))+
  theme(panel.grid = element_blank()) +
  theme(panel.spacing = unit(0.3, "lines"))+
   theme(strip.background = element_rect(color="transparent", fill="transparent"))+
    theme(strip.text = element_text(size = rel(2)))+
  theme(axis.title = element_text(size = rel(2), colour = "black"))+
  theme(axis.text = element_text(size = rel(1.5), colour = "black"))

#plot_predict_GER_table_sensAnalysis_phase2

```



```{r predict_GER_table_sensAnalysis_preg, echo= FALSE, results = "hide", message = FALSE, warning=FALSE, fig.width=10,fig.height=5}
#Read in data
predict_GER_table_sensAnalysis_preg <-
  as_tibble(read_csv("data/predict_GER_table_sensAnalysis_preg.csv"))


predict_GER_table_sensAnalysis_preg$MC_var_factor <- 
  factor(predict_GER_table_sensAnalysis_preg$MC_variable, 
         levels=c("all","P_cost","Es", "E_FnU", "Hg", "P_nb", "GER_calf"))

levels(predict_GER_table_sensAnalysis_preg$MC_var_factor) <- c("All variables","P", "Es", "E F+U", "Hg", "P newborn", "GER calf first 6mo.")


plot_predict_GER_sensAnalysis_preg <- predict_GER_table_sensAnalysis_preg %>%
  filter(age_yrs>1 & age_yrs <=30) %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs, 
                    ymin = mean_GER - GER_sd, 
                    ymax = mean_GER + GER_sd), 
                width=0, size = 0.5, linetype = 1,color="gray80") + 
  geom_point(aes(x = age_yrs, y= mean_GER), 
             shape = 21, fill = "white")+
  geom_errorbar(aes(x = age_yrs, 
                    ymin = GER_foraging - sd_foraging, 
                    ymax = GER_foraging + sd_foraging), 
                width=0, size =0.5, linetype = 1, color="gray40") + 
  geom_point(aes(x = age_yrs, y= GER_foraging), 
             shape = 21, fill = "black")+
  #facet_grid(~MC_variable)+
  facet_grid(phase~MC_var_factor, 
             labeller = label_wrap_gen(width=15, multi_line = TRUE)) +
  #facet_wrap(~MC_variable)+
  xlab("Age (years)") +
   ylab(bquote('GER (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), 
                     limits = c(8, 30)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4)
                     #limits = c(0,max(plot_predict_GER_sensAnalysis_preg$quant975_foraging))
  ) +
  #ggtitle("Pregnant females")+
  theme_bw()+
    labs(tag = "C")+
  theme(plot.tag = element_text(size = rel(3), 
                                colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(panel.spacing = unit(0.3, "lines"))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))+
    theme(strip.text = element_text(size = rel(2)))+
  theme(axis.text = element_text(size = rel(1.5),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(2)),
        axis.title.y = element_text(size = rel(2)))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))
  #theme(strip.text = element_text(size = rel(1.5)))

#plot_predict_GER_sensAnalysis_preg              


```



```{r predict_GER_table_sensAnalysis_lact, echo= FALSE, results = "hide", message = FALSE, warning=FALSE, fig.width=10,fig.height=5}

#Read in data
predict_GER_table_sensAnalysis_lact <-
  as_tibble(read_csv("data/predict_GER_table_sensAnalysis_lact.csv"))


predict_GER_table_sensAnalysis_lact$MC_var_factor <- 
  factor(predict_GER_table_sensAnalysis_lact$MC_variable, 
         levels=c("all","P_cost","Es", "E_FnU","GERcalf"))

levels(predict_GER_table_sensAnalysis_lact$MC_var_factor) <- c("All variables","P", "Es", "E F+U", "GER calf last 3.6mo.")

plot_predict_GER_sensAnalysis_lact <- predict_GER_table_sensAnalysis_lact %>%
    filter(age_yrs>1 & age_yrs <=30) %>% 
  ggplot() +
  geom_errorbar(aes(x = age_yrs, 
                    ymin = mean_GER - GER_sd, 
                    ymax = mean_GER + GER_sd), 
                width=0, size = 0.5, linetype = 1,color="gray80") + 
  geom_point(aes(x = age_yrs, y= mean_GER), 
             shape = 21, fill = "white")+
  geom_errorbar(aes(x = age_yrs, 
                    ymin = GER_foraging - sd_foraging, 
                    ymax = GER_foraging + sd_foraging), 
                width=0, size = 0.5, linetype = 1, color="gray40") + 
  geom_point(aes(x = age_yrs, y= GER_foraging), 
             shape = 21, fill = "black")+
  #facet_grid(~MC_variable)+
 facet_grid(phase~MC_var_factor, 
             labeller = label_wrap_gen(width=15, multi_line = TRUE)) +
  #facet_wrap(~MC_variable)+
  xlab("Age (years)") +
  ylab(bquote('GER (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), 
                     limits = c(8, 30)) +  # max x-axis 30 yrs. 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4)
                     #limits = c(0,max(plot_predict_GER_sensAnalysis_lact$quant975_foraging))
  ) +
#    ggtitle("Lactating females")+
  theme_bw()+
    labs(tag = "D")+
  theme(plot.tag = element_text(size = rel(3), colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(panel.spacing = unit(0.3, "lines"))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))+
    theme(strip.text = element_text(size = rel(2)))+
  theme(axis.text = element_text(size = rel(1.5),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(2)),
        axis.title.y = element_text(size = rel(2)))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))
  #theme(strip.text = element_text(size = rel(1.5)))

#plot_predict_GER_sensAnalysis_lact          

```




```{r panel plot Es sensitivity analysis all stages, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}


multiplot(plot_predict_GER_sensAnalysis_phase1_permth,
          plot_predict_GER_table_sensAnalysis_phase2,
          plot_predict_GER_sensAnalysis_preg,  
          plot_predict_GER_sensAnalysis_lact, 
          cols=1)


jpeg(filename = paste0(Figurespath,"/GER_sensanalysis_allstages_multiplot.jpg"), 
     width = 5000,
     height = 5000,
     pointsize = 35, 
     quality = 100, 
     bg = "white", 
     res = 300, 
     restoreConsole = TRUE)


p <- multiplot(plot_predict_GER_sensAnalysis_phase1_permth,
          plot_predict_GER_table_sensAnalysis_phase2,
          plot_predict_GER_sensAnalysis_preg,  
          plot_predict_GER_sensAnalysis_lact, 
          cols=1)


dev.off()

```

Figure XX. Results for the sensitivity analysis on gross energy requirements (*GER*). 


### Total energetic expenditure (*E~s~*)

#### Grey whale calves

```{r Es_sensAnalysis_phase1_permth, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}


Es_sensAnalysis_phase1_permth <-  read_csv("data/Es_sensAnalysis_phase1_permth_source_bpm.csv")

Es_sensAnalysis_phase1_permth$Lifestage =
  factor(Es_sensAnalysis_phase1_permth$Lifestage,  
         levels=c('Calf'))

Es_sensAnalysis_phase1_permth$MC_variable <- 
  factor(Es_sensAnalysis_phase1_permth$MC_variable, 
         levels=c("all","pctO2", "Rs", "Vt" ))

levels(Es_sensAnalysis_phase1_permth$MC_variable) <- c("All variables","%O2", "Rs", "Vt")


plot_Es_sensAnalysis_phase1_permth <- Es_sensAnalysis_phase1_permth %>% 
  #dplyr::filter(age_yrs == i) %>% 
  ggplot(aes(x = age_mth-0.5, y =Es_perday)) +
  geom_errorbar(aes(ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                linetype = 1, size = 0.5, colour = 'gray40', width = 0) +
  geom_point() +
  facet_grid(Lifestage~MC_variable)+
  xlab("Age (months)") +
  ylab(bquote('Es (MJ day'^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), 
                      limits = c(0, 12.5)) +  # max x-axis 30 yrs. 
  scale_y_continuous(label = comma, 
                     breaks = scales::pretty_breaks(n = 4)
                     #limits = c(0,1500)
                     ) +
  theme_bw()+
  labs(tag="A")+
  theme(plot.tag = element_text(size = rel(2),
                                    colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(panel.spacing = unit(0.6, "lines"))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))+
  theme(axis.title.x = element_text(size = rel(1),
                                    colour = "black"))+
  theme(axis.title.y = element_text(size = rel(1),
                                    colour = "black"))+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))  
#ggtitle("Es table Phase 1 - per mth")

plot_Es_sensAnalysis_phase1_permth

```





```{r Es sens analysis phase 1 stacked, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

Es_sensAnalysis_phase1 <- read_csv("data/Es_sensAnalysis_phase1_source_bpm.csv")

Es_sensAnalysis_phase1$age_mth <- round((Es_sensAnalysis_phase1$age_yrs*12),0)

Es_sensAnalysis_phase1$MC_var_factor <- 
  factor(Es_sensAnalysis_phase1$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))


levels(Es_sensAnalysis_phase1$MC_var_factor) <- c("All variables","%O2", "Rs", "Vt")

plot_Es_sensAnalysis_phase1 <- Es_sensAnalysis_phase1 %>% 
  ggplot(aes(x = age_mth, y = Es_perday))+
  geom_errorbar(aes(ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                 colour = "gray45", width = 0)+
  geom_point(size=0.5)+
  # geom_ribbon(aes(ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
  #               fill = "gray70")+
  # geom_line(linewidth = 0.5)+
  facet_grid(MC_var_factor~Activity_stages, 
             labeller = label_wrap_gen(width = 15, multi_line = TRUE)) +
             
  #ggtitle("Phase 2 - Juveniles/Adults")+
  xlab("Age (months)") +
  ylab(bquote('Es (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                     limits = c(0, 12))+
  #limits = c(0, 30.5), expand=c(0,0) +  # max x-axis 30 yrs.
  # scale_y_continuous(label=comma,
  #                     breaks = scales::pretty_breaks(n = 4),
  #                     limits =  c(0, 2000))+

  theme_bw() +
  labs(tag="A")+
  theme(plot.tag = element_text(size = rel(2),
                                    colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(legend.position.inside = 0)+
  #theme(panel.border = element_blank())+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  #theme(axis.line = element_line(linewidth = 1, colour = "black"))+
  theme(axis.text = element_text(colour = "black", size = rel(1)))+
  theme(axis.title.y = element_text(colour = "black", 
                                    size = rel(1), angle = 90))+
  theme(axis.title.x = element_text(colour = "black", 
                                    size = rel(1)))+
  theme(strip.text = element_text(size = rel(1)))


plot_Es_sensAnalysis_phase1

ggsave(paste0(Figurespath,"/Es_sensanalysis_phase1_activitystages_facetgrid.jpg"),
       plot_Es_sensAnalysis_phase1,
       width = 8,
       height = 5, dpi = 300
     )



```


Figure 18. Results for the sensitivity analysis on total energetic expenditure (*E~s~*) for grey whale calves.

#### Grey whale juveniles and adults, including pregnant and lactating females

```{r Es_sensAnalysis_alladults_preg_lact, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

#Read in data
Es_sensAnalysis_alladults_preg_lact_peryear <-
  as_tibble(read_csv("data/Es_sensAnalysis_alladults_preg_lact_peryear_source_bpm.csv"))

# apply factors to enable facet wrap 
Es_sensAnalysis_alladults_preg_lact_peryear$Lifestage =
  factor(Es_sensAnalysis_alladults_preg_lact_peryear$Lifestage,  
         levels=c('Juvenile/Adult','Pregnant','Lactating'))


Es_sensAnalysis_alladults_preg_lact_peryear$MC_var_factor <- 
  factor(Es_sensAnalysis_alladults_preg_lact_peryear$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))

levels(Es_sensAnalysis_alladults_preg_lact_peryear$MC_var_factor) <- 
  c("All variables","%O2", "Rs", "Vt")



# Designing the plot 
plot_Es_sensAnalysis_alladults_preg_lact_yearly_perday <-
  Es_sensAnalysis_alladults_preg_lact_peryear %>% 
    filter(age_yrs>1 & age_yrs <=30) %>% 
  ggplot(aes(x = age_yrs, y =Es_perday)) + #shape = Lifestage
  #facet_grid(Lifestage_f ~ MC_variable)+
    facet_grid(Lifestage~MC_var_factor)+
  geom_errorbar(aes(x = age_yrs, ymin = Es_perday - Es_sd_perday, ymax = Es_perday + Es_sd_perday),
                size = 0.5, colour = 'gray40', width = 0, linetype = 1) +
  # geom_ribbon(aes(x = age_yrs, ymin = Es - Es_sd, ymax = Es + Es_sd),
  #                 fill = 'gray40', alpha = 0.3) +
  geom_point(size = 1)+
  #geom_line()   +
  xlab("Age (years)") +
  
  ylab(bquote('Es (MJ day'^'-1'*')')) +
  
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), 
                     limits = c(0, 32)) +  # max x-axis 30 yrs. 
  scale_y_continuous(label = comma, 
                     breaks = scales::pretty_breaks(n = 4),
                     limits = c(0,1500))+
  # scale_y_continuous(label = function(x){(x/1000)}, breaks = scales::pretty_breaks(n = 8),
  #                    limits = c(0, 1000000))+
  
  theme_bw()+
  labs(tag="B")+
  theme(plot.tag = element_text(size = rel(2),
                                    colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(1)),
        axis.title.y = element_text(size = rel(1)))+
  theme(strip.background = element_rect(
    color="transparent", fill="transparent"))+
  theme(panel.spacing = unit(0.6, "lines"))+
  theme(strip.text = element_text(size = rel(1)))
#theme(legend.position = "none")

plot_Es_sensAnalysis_alladults_preg_lact_yearly_perday


multiplot(plot_Es_sensAnalysis_phase1_permth, 
          plot_Es_sensAnalysis_alladults_preg_lact_yearly_perday,
          cols=1)


ggarrange(plot_Es_sensAnalysis_phase1_permth,
          plot_Es_sensAnalysis_alladults_preg_lact_yearly_perday, ncol = 1, heights = c(1, 2))

```

Figure 19. Results for the sensitivity analysis on *E~s~* (total energetic expenditure) for Juvenile and adult grey whales, including pregnant and lactating females.



```{r plots_Es_phase2_peryear, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

Es_sensAnalysis_phase2_peryear <-  read_csv("data/Es_sensAnalysis_phase2_peryear_source_bpm.csv")

Es_sensAnalysis_phase2_peryear <- Es_sensAnalysis_phase2_peryear %>% 
filter(Lifestage == "Juvenile/Adult" & age_yrs >= 1 & age_yrs < 30)

  
Es_sensAnalysis_phase2_peryear$MC_var_factor <- 
  factor(Es_sensAnalysis_phase2_peryear$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))
########################################
########################################
MC_var_factor.labs <- c("All variables","%O2 absorbed", "Resp. rates", "Tidal Vol.")
names(MC_var_factor.labs) <- c("all","pctO2","Rs", "Vt")


plot_Es_sensAnalysis_phase2_peryear <- Es_sensAnalysis_phase2_peryear %>% 
  
  ggplot() +
  geom_errorbar(aes(x = age_yrs, ymin = Es_perday - Es_sd_perday, 
                    ymax = Es_perday + Es_sd_perday),
                linetype = 1, colour = 'gray40', width = 0) +
  geom_point(aes(x = age_yrs, y =Es_perday)) +
  facet_grid(~MC_var_factor, 
             labeller = labeller(MC_var_factor = MC_var_factor.labs)) +
  xlab("Age (years)") +
  ylab(bquote('Energetic expenditure (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10))+
                     #limits = c(0, 30.5), expand=c(0,0)) +  # max x-axis 30 yrs.
  scale_y_continuous(label=comma,
                     breaks = scales::pretty_breaks(n = 10))+
                     #limits = c(0,1400), expand=c(0,0))+
  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(panel.spacing = unit(0.6, "lines"))+
  theme(legend.position = 0)+
  # theme(plot.background = element_rect(fill = "black"))+
  # theme(panel.background = element_rect(fill = "black"))+
  #theme(panel.border = element_blank())+
  theme(axis.line = element_line(size = 1, colour = "gray75"))+
  theme(axis.text = element_text(colour = "black", size = rel(1.2)))+
  theme(axis.title.y = element_text(colour = "black", 
                                    size = rel(1.4), angle = 90))+
  theme(axis.title.x = element_text(colour = "black", 
                                    size = rel(1.4)))+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1)))

plot_Es_sensAnalysis_phase2_peryear
```


```{r plots_Es_phase2_stacked, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

Es_sensAnalysis_phase2 <- read_csv("data/Es_sensAnalysis_phase2_source_bpm.csv")

Es_sensAnalysis_phase2 <-Es_sensAnalysis_phase2 %>% 
filter(Lifestage == "Juvenile/Adult" & age_yrs >= 1 & age_yrs < 30)

  
Es_sensAnalysis_phase2$MC_var_factor <- 
  factor(Es_sensAnalysis_phase2$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))

levels(Es_sensAnalysis_phase2$MC_var_factor) <- c("All variables","%O2", "Rs", "Vt")


Es_sensAnalysis_phase2$Activity_stages_factor <- 
  factor(Es_sensAnalysis_phase2$Activity_stages, 
         levels=c("calving grounds","foraging", "northbound", "southbound"))


plot_Es_sensAnalysis_phase2 <- Es_sensAnalysis_phase2 %>% 
    filter(age_yrs>1 & age_yrs <=30) %>% 
  mutate(across(Activity_stages_factor, ~factor(., levels=c("calving grounds","northbound","foraging","southbound")))) %>% 
  ggplot(aes(x = age_yrs, y = Es_perday))+
  geom_errorbar(aes(ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                 colour = "gray40", width = 0.02)+
  geom_point(size=0.5)+
  # geom_ribbon(aes(ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
  #               fill = "gray70")+
  # geom_line(linewidth = 0.5)+
  facet_grid(MC_var_factor~Activity_stages_factor,
             labeller = labeller(label_wrap_gen(width = 15, multi_line = TRUE))) +
             
  #ggtitle("Phase 2 - Juveniles/Adults")+
  xlab("Age (years)") +
  ylab(bquote('Es (MJ day '^'-1'*')')) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                     limits = c(0, 30.5))+
  #limits = c(0, 30.5), expand=c(0,0) +  # max x-axis 30 yrs.
  scale_y_continuous(label=comma,
                      breaks = scales::pretty_breaks(n = 4),
                      limits =  c(0, 2000))+

  theme_bw() +
   labs(tag="B")+
  theme(plot.tag = element_text(size = rel(2),
                                    colour = "black"))+
  theme(panel.grid = element_blank())+
  theme(legend.position.inside = 0)+
  #theme(panel.border = element_blank())+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  #theme(axis.line = element_line(linewidth = 1, colour = "black"))+
  theme(axis.text = element_text(colour = "black", size = rel(1)))+
  theme(axis.title.y = element_text(colour = "black", 
                                    size = rel(1), angle = 90))+
  theme(axis.title.x = element_text(colour = "black", 
                                    size = rel(1)))+
  theme(strip.text = element_text(size = rel(1)))


plot_Es_sensAnalysis_phase2

ggsave(paste0(Figurespath,"/Es_sensanalysis_phase2_activitystages_facetgrid.jpg"),
       plot_Es_sensAnalysis_phase2,
       width = 8,
       height = 5, 
       dpi = 300
     )

ES_stacked_phase1_2_multipanel <- ggarrange(plot_Es_sensAnalysis_phase1, plot_Es_sensAnalysis_phase2, 
            ncol = 1) 

ES_stacked_phase1_2_multipanel

ggsave(paste0(Figurespath,"/S_stacked_phase1_2_multipanel.jpg"),
       ES_stacked_phase1_2_multipanel,
       width = 8,
       height = 10, dpi = 300
     )



```





__Es for all adult life stages including pregnant and lactating__

```{r Es preg lact, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

#read in preg and lact table. 
Es_sensAnalysis_alladults_preg_lact_peryear <-  read_csv("data/Es_sensAnalysis_alladults_preg_lact_peryear_source_bpm.csv")

# apply factors to enable facet wrap
Es_sensAnalysis_alladults_preg_lact_peryear$Lifestage_f =
  factor(Es_sensAnalysis_alladults_preg_lact_peryear$Lifestage,
         levels=c('Juvenile/Adult','Pregnant','Lactating'))

Es_sensAnalysis_alladults_preg_lact_peryear$MC_var_factor <- 
  factor(Es_sensAnalysis_alladults_preg_lact_peryear$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))

levels(Es_sensAnalysis_alladults_preg_lact_peryear$MC_var_factor) <-   c("All variables","%O2", "Rs", "Vt")

# plots

plot_Es_sensAnalysis_alladults_preg_lact_yearly_perday <- Es_sensAnalysis_alladults_preg_lact_peryear %>%
    filter(age_yrs>1 & age_yrs <=30) %>% 
  ggplot(aes(x = age_yrs, y =Es_perday)) + #shape = Lifestage
  facet_grid(MC_var_factor~Lifestage_f, 
             labeller = label_wrap_gen(width = 2, multi_line = TRUE))+
  geom_errorbar(aes(x = age_yrs, ymin = Es_perday - Es_sd_perday, ymax = Es_perday + Es_sd_perday),
                colour = 'gray40', width = 0, linetype = 1) +
  # geom_ribbon(aes(x = age_yrs, ymin = Es - Es_sd, ymax = Es + Es_sd),
  #                 fill = 'gray40', alpha = 0.3) +
  geom_point(size=0.5)+
  #geom_line()   +
  xlab("Age (years)") +

  ylab(bquote('Energetic expenditure (MJ day'^'-1'*')')) +

  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                     limits = c(0, 32)) +  # max x-axis 30 yrs.
  scale_y_continuous(label = comma,
                     breaks = scales::pretty_breaks(n = 6),
                     limits = c(0,1500))+
  # scale_y_continuous(label = function(x){(x/1000)}, breaks = scales::pretty_breaks(n = 8),
  #                    limits = c(0, 1000000))+

  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(1)),
        axis.title.y = element_text(size = rel(1)))+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1)))
#theme(legend.position.inside = "none")

plot_Es_sensAnalysis_alladults_preg_lact_yearly_perday




```

__Sensitivity analysis for Es  (all life stages)__ 

```{r Es sensanalysis allstages multiplot, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}
Es_sensAnalysis_phase1_permth <-  read_csv("data/Es_sensAnalysis_phase1_permth_source_bpm.csv")
Es_sensAnalysis_phase1_permth <-Es_sensAnalysis_phase1_permth %>% 
  select(age_yrs, Lifestage, MC_variable, Es, Es_sd, 
         Es_perday, Es_perday_sd)


Es_sensAnalysis_alladults_preg_lact_peryear <-
  as_tibble(read_csv("data/Es_sensAnalysis_alladults_preg_lact_peryear_source_bpm.csv"))

Es_sensAnalysis_alladults_preg_lact_peryear <- Es_sensAnalysis_alladults_preg_lact_peryear %>% 
  rename("Es_perday_sd" = "Es_sd_perday")

Es_sensAnalysis_alladults_preg_lact_peryear <-Es_sensAnalysis_alladults_preg_lact_peryear %>% 
  select(age_yrs, Lifestage, MC_variable, Es, Es_sd, 
         Es_perday, Es_perday_sd)

Es_sensAnalysis_allstages_permth_peryr <- rbind(Es_sensAnalysis_phase1_permth, Es_sensAnalysis_alladults_preg_lact_peryear)

Es_sensAnalysis_allstages_permth_peryr$MC_var_factor <- 
  factor(Es_sensAnalysis_allstages_permth_peryr$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))

levels(Es_sensAnalysis_allstages_permth_peryr$MC_var_factor) <-   c("All variables","%O2", "Rs", "Vt")

Es_sensAnalysis_allstages_permth_peryr$Lifestage_factor <- factor(Es_sensAnalysis_allstages_permth_peryr$Lifestage, 
         levels=c("Calf","Juvenile/Adult","Pregnant", "Lactating"))


plot_Es_sensAnalysis_allstages_permth_peryr <- Es_sensAnalysis_allstages_permth_peryr %>%
    filter(age_yrs <=30) %>% 
    mutate(across(Lifestage_factor, ~factor(., levels=c("Calf","Juvenile/Adult","Pregnant","Lactating")))) %>%
  ggplot(aes(x = age_yrs, y =Es_perday)) + #shape = Lifestage
  facet_grid(MC_var_factor~Lifestage_factor, 
             scales="free_x",
             labeller = label_wrap_gen(width = 15, multi_line = TRUE))+
  geom_errorbar(aes(x = age_yrs, ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                 colour = 'gray40', width = 0, linetype = 1) +
  # geom_ribbon(aes(x = age_yrs, ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
  #                 fill = 'gray40', alpha = 0.3) +
  geom_point(size=0.5)+
  #geom_line()   +
  xlab("Age (years)") +

  ylab(bquote('Es (MJ day'^'-1'*')')) +
 
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                      ) +  # max x-axis 30 yrs.
  scale_y_continuous(label = comma,
  breaks = scales::pretty_breaks(n = 4),
  limits = c(0,1500))+
  #scale_y_continuous(label = function(x){(x/1000)}, breaks = scales::pretty_breaks(n = 8),
  #                    limits = c(0, 1000000))+

  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1.2),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(1.2)),
        axis.title.y = element_text(size = rel(1.2)))+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1.2)))
#theme(legend.position.inside = "none")

plot_Es_sensAnalysis_allstages_permth_peryr


ggsave(paste0(Figurespath,"/Es_sensAnalysis_allstages_permth_peryr.jpg"),
       plot_Es_sensAnalysis_allstages_permth_peryr,
       width = 9,
       height = 7, dpi = 300
     )


```


__Es sensitivity analysis for pregnant whales by activity stages__

```{r Es_preg_stacked, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

#read in preg  table. 
Es_sensAnalysis_preg  <-  read_csv("data/Es_sensAnalysis_preg_source_bpm.csv")


# apply factors to enable facet wrap

Es_sensAnalysis_preg$MC_var_factor <- 
  factor(Es_sensAnalysis_preg$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))

levels(Es_sensAnalysis_preg$MC_var_factor) <- c("All variables","%O2 absorbed", "Resp. rates", "Tidal Vol.")


plot_Es_sensAnalysis_preg <- Es_sensAnalysis_preg %>%
    filter(age_yrs>1 & age_yrs <=30) %>% 
  ggplot(aes(x = age_yrs, y =Es_perday)) + #shape = Lifestage
facet_grid(Activity_stages~MC_var_factor,
             labeller = label_wrap_gen(width = 5, multi_line = TRUE))+
            
  geom_errorbar(aes(x = age_yrs, ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                colour = 'gray70', width = 0, linetype = 1) +
  # geom_ribbon(aes(x = age_yrs, ymin = Es - Es_sd, ymax = Es + Es_sd),
  #                 fill = 'gray40', alpha = 0.3) +
  geom_point(size=0.5)+
  #geom_line()   +
  xlab("Age (years)") +

  ylab(bquote('Energetic expenditure (MJ day'^'-1'*')')) +

  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                     limits = c(0, 32)) +  # max x-axis 30 yrs.
  # scale_y_continuous(label = comma,
  #                    breaks = scales::pretty_breaks(n = 6),
  #                    limits = c(0,1500))+
  # scale_y_continuous(label = function(x){(x/1000)}, breaks = scales::pretty_breaks(n = 8),
  #                    limits = c(0, 1000000))+

  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(1)),
        axis.title.y = element_text(size = rel(1)))+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1)))
#theme(legend.position.inside = "none")

plot_Es_sensAnalysis_preg


```

__Es sensitivity analysis for lactating whales by activity stages__

```{r Es_lact_stacked, echo= FALSE, results = "hide", message = FALSE, warning=FALSE}

#read in lact  table. 
Es_sensAnalysis_lact  <-  read_csv("data/Es_sensAnalysis_lact_females_source_bpm.csv")

Es_sensAnalysis_lact$MC_var_factor <- 
  factor(Es_sensAnalysis_lact$MC_variable, 
         levels=c("all","pctO2","Rs", "Vt"))

levels(Es_sensAnalysis_lact$MC_var_factor) <- c("All variables","%O2", "Rs", "Vt")


plot_Es_sensAnalysis_lact <- Es_sensAnalysis_lact %>%
    filter(age_yrs>1 & age_yrs <=30) %>% 
  ggplot(aes(x = age_yrs, y =Es_perday)) + #shape = Lifestage
  facet_grid(Activity_stages~MC_var_factor,
             labeller = label_wrap_gen(width = 2, multi_line = TRUE))+
  geom_errorbar(aes(x = age_yrs, ymin = Es_perday - Es_perday_sd, ymax = Es_perday + Es_perday_sd),
                colour = 'gray70', width = 0, linetype = 1) +
  # geom_ribbon(aes(x = age_yrs, ymin = Es - Es_sd, ymax = Es + Es_sd),
  #                 fill = 'gray40', alpha = 0.3) +
  geom_point(size=0.5)+
  #geom_line()   +
  xlab("Age (years)") +

  ylab(bquote('Energetic expenditure (MJ day'^'-1'*')')) +

  scale_x_continuous(breaks = scales::pretty_breaks(n = 5),
                     limits = c(0, 32)) +  # max x-axis 30 yrs.
  scale_y_continuous(label = comma,
                     breaks = scales::pretty_breaks(n = 6),
                     limits = c(0,2000))+
  # scale_y_continuous(label = function(x){(x/1000)}, breaks = scales::pretty_breaks(n = 8),
  #                    limits = c(0, 1000000))+

  theme_bw()+
  theme(panel.grid = element_blank())+
  theme(axis.text = element_text(size = rel(1),
                                 colour = "black"))+
  theme(axis.title.x = element_text(size = rel(1)),
        axis.title.y = element_text(size = rel(1)))+
  theme(strip.background =element_rect(fill="transparent",
                                       colour = "transparent"))+
  theme(strip.text = element_text(size = rel(1)))
#theme(legend.position.inside = "none")

plot_Es_sensAnalysis_lact



```

